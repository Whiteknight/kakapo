## arguments we want to run parrot with
PARROT_ARGS   :=

## configuration settings
VERSION       := @versiondir@
BIN_DIR       := @bindir@
LIB_DIR       := @libdir@$(VERSION)
DOC_DIR       := @docdir@$(VERSION)
MANDIR        := @mandir@$(VERSION)


## Setup some commands
MAKE          := @make_c@
PERL          := @perl@
CAT           := @cat@
CHMOD         := @chmod@
CP            := @cp@
MKPATH        := @mkpath@
RM_F          := @rm_f@
RM_RF         := @rm_rf@
POD2MAN       := pod2man
#IF(parrot_is_shared and not(cygwin or win32)):export LD_RUN_PATH := @blib_dir@:$(LD_RUN_PATH)
PARROT        := $(BIN_DIR)/parrot@exe@
PARROT_NQP	:= $(BIN_DIR)/parrot_nqp@exe@
PBC_TO_EXE    := $(BIN_DIR)/pbc_to_exe@exe@
#IF(darwin):
#IF(darwin):# MACOSX_DEPLOYMENT_TARGET must be defined for OS X compilation/linking
#IF(darwin):export MACOSX_DEPLOYMENT_TARGET := @osx_version@

COMPILE_pg	:= $(PARROT) $(PARROT_ARGS) $(PERL6GRAMMAR)
COMPILE_nqp	:= $(PARROT_NQP)
COMPILE_pir	:= $(PARROT) $(PARROT_ARGS)
STRIP_PIRA		:= grep -v '^.annotate'

ALL_LIB_PIRS =		\
	$(BASE_LIB_PIRS)	\
	$(TEST_LIB_DIRS)

BASE_LIB_PIRS = 		\
	src/Array.pir		\
	src/Class.pir		\
	src/Config.pir	\
	src/Dumper.pir	\
	src/File.pir		\
	src/Hash.pir		\
	src/OS.pir		\
	src/Parrot.pir 	\
	src/Registry.pir 	\
	src/ConfigFile.pir	\
	src/String.pir

GENERATED_FILES =		\
	$(ALL_LIB_PIRS)		\
	library/kakapo.pir		\
	library/kakapo_base.pir	\
	library/kakapo_test.pir	\
	$(LIBRARY_PBCS)

LIBRARY_PBCS =			\
	library/kakapo.pbc		\
	library/kakapo_base.pbc	\
	library/kakapo_test.pbc
	
TEST_LIB_PIRS =		\
	src/Test/Testcase.pir	\
	src/Matchers/Defined.pir	\
	src/Matchers/DescribedAs.pir	\
	src/Matchers/Equals.pir	\
	src/Matchers/EqualsFloat.pir	\
	src/Matchers/Factory.pir	\
	src/Matchers/Matcher.pir	\
	src/Matchers/Not.pir	\
	src/Matchers/Null.pir	\
	src/Matchers/TypeSafe.pir	\

#######################################################################
##### Implicit rules here 
#######################################################################

# NOTE: Using "old sk00l" implicit rules here because Microsoft's Nmake supports those.
.SUFFIXES: .pg .nqp .pira .pir .pbc
.PRECIOUS: .pir

.pg.pira:
	@echo "*** Compiling to PIRA: $<"
	$(COMPILE_pg) --output=$@ $<

.nqp.pira: 
	@echo "*** Compiling to PIRA: $<"
	$(COMPILE_nqp) --target=pir --output=$@  $<

.pira.pir:
	@echo "*** Strip annotations PIRA->PIR: $<"
	$(STRIP_PIRA) $< > $@

.pir.pbc:
	@echo "*** Compiling to PBC: $<"
	$(COMPILE_pir) --output=$@ $<

#######################################################################
##### Targets start here (asciibetical order)
#######################################################################

ALL: all

Makefile: build/Makefile.in
	$(PERL) Configure.pl

all: build

build:	kakapo.cfg $(LIBRARY_PBCS)
	@echo "Build complete"

clean:
	$(RM_F) $(GENERATED_FILES)

distclean: realclean

# This is a listing of all targets, that are meant to be called by users
help:
	@echo ""
	@echo "The following targets are available for the user:"
	@echo ""
	@echo "  all:               build (This is the default target.)"
	@echo "  build:             kakapo.cfg library/kakapo.pbc (+2 others)"
	@echo ""
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo "  testclean:         Clean up test results."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleanup."
	@echo "  realclean:         Also removes files generated by 'Configure.pl'"
	@echo "  distclean:         Also removes also anything built, in theory"
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""

kakapo.cfg:
#IF(win32):	IF NOT EXIST kakapo.cfg $(CP) kakapo_cfg.tmpl kakapo.cfg
#IF(not(win32)):	if [ ! -f kakapo.cfg ]; then $(CP) kakapo_cfg.tmpl kakapo.cfg ; fi

library/kakapo.pir: $(ALL_LIB_PIRS)
	cat $(ALL_LIB_PIRS) > $@

library/kakapo_base.pir: $(BASE_LIB_PIRS)
	cat $(BASE_LIB_PIRS) > $@

library/kakapo_test.pir: $(TEST_LIB_PIRS)
	cat $(TEST_LIB_PIRS) > $@

install:
	# install kakapo main
	$(CP) library/kakapo.pbc $(LIB_DIR)/library/kakapo.pbc
	$(CHMOD) 0444 $(LIB_DIR)/library/kakapo.pbc
	# install kakapo_base
	$(CP) library/kakapo_base.pbc $(LIB_DIR)/library/kakapo_base.pbc
	$(CHMOD) 0444 $(LIB_DIR)/library/kakapo_base.pbc
	# install kakapo_test
	$(CP) library/kakapo_test.pbc $(LIB_DIR)/library/kakapo_test.pbc
	$(CHMOD) 0444 $(LIB_DIR)/library/kakapo_test.pbc
	# install docs
	-$(MKPATH) $(DOC_DIR)/kakapo
	$(CP) $(DOC_FILES) $(DOC_DIR)/kakapo

realclean: clean
	$(RM_F) Makefile

testclean:
	$(RM_F) $(TEST_CLEANUPS)

uninstall:
	$(RM_F) $(LIB_DIR)/library/kakapo.pbc
	$(RM_F) $(LIB_DIR)/library/kakapo_base.pbc
	$(RM_F) $(LIB_DIR)/library/kakapo_test.pbc
	$(RM_RF) $(DOC_DIR)/kakapo
