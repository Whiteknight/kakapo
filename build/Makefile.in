## arguments we want to run parrot with
PARROT_ARGS   :=

## configuration settings
VERSION       := @versiondir@
BIN_DIR       := @bindir@
LIB_DIR       := @libdir@$(VERSION)
DOC_DIR       := @docdir@$(VERSION)
MANDIR        := @mandir@$(VERSION)


## Setup some commands
MAKE          := @make_c@
PERL          := @perl@
CAT           := @cat@
CHMOD         := @chmod@
CP            := @cp@
LINK          := $(BIN_DIR)/pbc_merge@exe@
MKPATH        := @mkpath@
RM_F          := @rm_f@
RM_RF         := @rm_rf@
POD2MAN       := pod2man
#IF(parrot_is_shared and not(cygwin or win32)):export LD_RUN_PATH := @blib_dir@:$(LD_RUN_PATH)
PARROT        := $(BIN_DIR)/parrot@exe@
PARROT_NQP	:= $(BIN_DIR)/parrot-nqp@exe@
PBC_TO_EXE    := $(BIN_DIR)/pbc_to_exe@exe@
#IF(darwin):
#IF(darwin):# MACOSX_DEPLOYMENT_TARGET must be defined for OS X compilation/linking
#IF(darwin):export MACOSX_DEPLOYMENT_TARGET := @osx_version@

COMPILE_pg	:= $(PARROT) $(PARROT_ARGS) $(PERL6GRAMMAR)
COMPILE_nqp	:= $(PARROT_NQP)
COMPILE_pir	:= $(PARROT) $(PARROT_ARGS)
STRIP_PIRA	:= grep -v '^.annotate'

# FIXME: This should go away, replaced by some kind of AllTests mechanism that gloms the tests together in a single suite.
ALL_TESTS =		\
	t-pmc-common	\
	t-pmc-float		\
	t-pmc-sub		\
	t-pmc-undef	\
	t-unittest-loader	\
	t-unittest-suite	\
	t-unittest-testcase	\

BASE_LIB_PIRS = 		\
	src/Classes/P6metaclass.pir	\
	src/Classes/P6object.pir	\
	src/Exceptions.pir		\
	src/Pmc/COMMON.pir	\
	src/Pmc/Exception.pir	\
	src/Pmc/Hash.pir		\
	src/Pmc/Undef.pir	\
	src/ConfigFile.pir		\
	src/DependencyQueue.pir \
	src/Dumper.pir		\
	src/Global.pir		\
	src/Kakapo.pir		\
	src/Parrot.pir 		\
	src/Parrot/Opcode.pir 	\
	src/Pir.pir 			\
	src/Pmc/Array.pir		\
	src/Pmc/Class.pir		\
	src/Pmc/Config.pir	\
	src/Pmc/File.pir		\
	src/Pmc/Namespace.pir	\
	src/Pmc/OS.pir		\
	src/Pmc/ResizablePMCArray.pir \
	src/Pmc/ResizableStringArray.pir \
	src/Pmc/String.pir	\
	src/Pmc/Sub.pir		\
	src/Program.pir		\
	src/Classes/Class.pir	\
	src/Classes/ArrayBased.pir	\
	src/Classes/BaseBehavior.pir	\
	src/Classes/HashBased.pir	\

GENERATED_FILES =		\
	$(BASE_LIB_PIRS)	\
	$(TEST_LIB_PIRS)	\
	library/kakapo_base.pir	\
	library/kakapo_test.pir	\
	src/kakapo_bottom.pir	\
	src/kakapo_top.pir	\
	$(KRT0)			\
	$(LIBRARY_PBCS)

KRT0 = 				\
	library/krt0.pbc
	
LIBRARY_PBCS =			\
	library/kakapo_base.pbc	\
	library/kakapo_test.pbc		\
	$(KRT0)

TEST_CLEANUPS =			\
	t/Global.pir				\
	t/Parrot.pir				\
	t/Pmc/test-array.pbc		\
	t/Pmc/test-array.pir		\
	t/Pmc/Array.pir			\
	t/Program.pir			\
	t/Pmc/test-rpa.pbc		\
	t/Pmc/test-rsa.pbc		\
	t/Pmc/test-undef.pbc		\
	t/Classes/test-Attributes.pbc	\
	t/Sanity/test-P6object.pbc	\
	t/Classes/Attributes.pbc		\
	t/Pmc/Array.pbc			\
	t/Pmc/ResizablePMCArray.pbc\
	t/Pmc/ResizableStringArray.pbc\
	t/Pmc/Undef.pbc			\
	t/Sanity/P6object.pbc		

TEST_LIB_PIRS =			\
	src/Matchers/AllOf.pir		\
	src/Matchers/AnyOne.pir	\
	src/Matchers/Boolean.pir	\
	src/Matchers/Defined.pir	\
	src/Matchers/DescribedAs.pir	\
	src/Matchers/Elements.pir		\
	src/Matchers/Empty.pir		\
	src/Matchers/Equals.pir		\
	src/Matchers/EqualsArray.pir		\
	src/Matchers/EqualsFloat.pir		\
	src/Matchers/Factory.pir		\
	src/Matchers/InstanceOf.pir		\
	src/Matchers/Matcher.pir		\
	src/Matchers/Not.pir			\
	src/Matchers/TypeSafe.pir		\
	src/UnitTest/Listeners.pir		\
	src/UnitTest/Loader.pir			\
	src/UnitTest/Result.pir			\
	src/UnitTest/Suite.pir			\
	src/UnitTest/Testcase.pir		\
	
#	src/Matchers/IdenticalTo.pir	\	
#	src/Matchers/Null.pir		\
#	src/Matchers/True.pir		\

#######################################################################
##### Implicit rules here 
#######################################################################

# NOTE: Using "old sk00l" implicit rules here because Microsoft's Nmake supports those.
.SUFFIXES: 
.SUFFIXES: .pg .nqp .pira .pir .pbc .pbx
.PRECIOUS: .pir

.pg.pira:
	@echo "*** Compiling to PIRA: $<"
	$(COMPILE_pg) --output=$@ $<

.nqp.pira: 
	@echo "*** Compiling to PIRA: $<"
	$(COMPILE_nqp) --target=pir --output=$@  $<

.pira.pir:
	@echo "*** Strip annotations PIRA->PIR: $<"
	$(STRIP_PIRA) $< > $@

.pir.pbc:
	@echo "*** Compiling to PBC: $<"
	$(COMPILE_pir) --output=$@ $<
	
#######################################################################
##### Targets start here (asciibetical order)
#######################################################################

ALL: all

Makefile: build/Makefile.in
	$(PERL) Configure.pl

all: build

build:	kakapo.cfg $(LIBRARY_PBCS)
	@echo "Build complete"

CHANGES:	src/package.nqp
	$(CP) src/package.nqp $@

clean: testclean
	$(RM_F) $(GENERATED_FILES)

distclean: realclean

# This is a listing of all targets, that are meant to be called by users
help:
	@echo ""
	@echo "The following targets are available for the user:"
	@echo ""
	@echo "  all:               build (This is the default target.)"
	@echo "  build:             kakapo.cfg library/kakapo_*.pbc"
	@echo ""
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo "  testclean:         Clean up test results."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleanup."
	@echo "  realclean:         Also removes files generated by 'Configure.pl'"
	@echo "  distclean:         Also removes also anything built, in theory"
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""

kakapo.cfg:
#IF(win32):	IF NOT EXIST kakapo.cfg $(CP) kakapo_cfg.tmpl kakapo.cfg
#IF(not(win32)):	if [ ! -f kakapo.cfg ]; then $(CP) kakapo_cfg.tmpl kakapo.cfg ; fi

library/kakapo_base.pir: $(BASE_LIB_PIRS) src/kakapo_top.pir src/kakapo_bottom.pir Makefile
	cat src/kakapo_top.pir $(BASE_LIB_PIRS) src/kakapo_bottom.pir > $@

library/kakapo_test.pir: $(BASE_LIB_PIRS) $(TEST_LIB_PIRS) src/kakapo_top.pir src/kakapo_bottom.pir Makefile
	cat src/kakapo_top.pir $(BASE_LIB_PIRS) $(TEST_LIB_PIRS) src/kakapo_bottom.pir > $@

library/krt0.pir: src/krt0_pir.tmpl
	$(CP) src/krt0_pir.tmpl $@

install:
	# install kakapo_base
	$(CP) library/kakapo_base.pbc $(LIB_DIR)/library/kakapo_base.pbc
	$(CHMOD) 0444 $(LIB_DIR)/library/kakapo_base.pbc
	# install kakapo_test
	$(CP) library/kakapo_test.pbc $(LIB_DIR)/library/kakapo_test.pbc
	$(CHMOD) 0444 $(LIB_DIR)/library/kakapo_test.pbc
	# install krt0
	$(CP) library/krt0.pbc $(LIB_DIR)/library/krt0.pbc
	$(CHMOD) 0444 $(LIB_DIR)/library/krt0.pbc
	# install docs
	-$(MKPATH) $(DOC_DIR)/kakapo
	$(CP) $(DOC_FILES) $(DOC_DIR)/kakapo

realclean: clean 
	$(RM_F) Makefile

release: build
	-$(MKPATH) released
	$(CP) library/kakapo_base.pir released/kakapo_base.pir
	$(CP) library/kakapo_test.pir released/kakapo_test.pir
	$(CP) library/krt0.pir released/krt0.pir
	
src/kakapo_bottom.pir: src/kakapo_bottom_pir.tmpl
	$(CP) src/kakapo_bottom_pir.tmpl $@
	
src/kakapo_top.pir: src/kakapo_top_pir.tmpl
	$(CP) src/kakapo_top_pir.tmpl $@

test: build $(ALL_TESTS)

#----------------------------------------------------------------------
# Individual test-foo targets 
#----------------------------------------------------------------------

t-global: build t/Global.t.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Global.t.pbc

t-matchers-boolean: build t/Matchers/Boolean.t.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Matchers/Boolean.t.pbc

t-pmc-common: build t/Pmc/COMMON.t.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/COMMON.t.pbc

t-pmc-float: build t/Pmc/Float.t.pbc   t/Pmc/COMMON.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/Float.t.pbc
	
t-pmc-sub: build t/Pmc/Sub.t.pbc   t/Pmc/COMMON.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/Sub.t.pbc
	
t-pmc-undef: build t/Pmc/Undef.t.pbc   t/Pmc/COMMON.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/Undef.t.pbc
	
t-unittest: build t/UnitTest/AllTests.t.pbc   t/UnitTest/Loader.pbc   t/UnitTest/Suite.pbc   t/UnitTest/Testcase.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/UnitTest/AllTests.t.pbc

t-unittest-loader: build t/UnitTest/Loader.t.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/UnitTest/Loader.t.pbc

t-unittest-suite: build t/UnitTest/Suite.t.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/UnitTest/Suite.t.pbc

t-unittest-testcase: build t/UnitTest/Testcase.t.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/UnitTest/Testcase.t.pbc

# Need fixin
t-pmc-array: build t/Pmc/test-array.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/test-array.pbc

test-parrot: build t/Parrot.pir
	$(PARROT) $(PARROT_FLAGS) t/Parrot.pir

test-program: build t/Program.pir
	$(PARROT) $(PARROT_FLAGS) t/Program.pir

test-rpa: build t/Pmc/test-rpa.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/test-rpa.pbc

test-rsa: build $(KRT0) t/Pmc/test-rsa.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/test-rsa.pbc

test-undef: build t/Pmc/test-undef.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Pmc/test-undef.pbc

test-attributes: build t/Classes/test-Attributes.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Classes/test-Attributes.pbc

test-sanity-p6object: build t/Sanity/test-P6object.pbc
	$(PARROT) $(PARROT_FLAGS) -Llibrary t/Sanity/test-P6object.pbc

#----------------------------------------------------------------------
# Compile rules that support the test-foo targets, above.
#----------------------------------------------------------------------

t/Global.t.pbc: $(KRT0) t/Global.pbc
	$(LINK) --output=$@  $(KRT0) t/Global.pbc > $@

t/Matchers/Boolean.t.pbc: $(KRT0) t/Matchers/Boolean.pbc
	$(LINK) --output=$@  $(KRT0) t/Matchers/Boolean.pbc > $@

t/Pmc/COMMON.t.pbc: $(KRT0) t/Pmc/COMMON.pbc
	$(LINK) --output=$@  $(KRT0) t/Pmc/COMMON.pbc > $@

t/Pmc/Float.t.pbc: $(KRT0) t/Pmc/Float.pbc
	$(LINK) --output=$@  $(KRT0) t/Pmc/Float.pbc > $@

t/Pmc/Sub.t.pbc: $(KRT0) t/Pmc/Sub.pbc
	$(LINK) --output=$@  $(KRT0) t/Pmc/Sub.pbc > $@

t/Pmc/Undef.t.pbc: $(KRT0) t/Pmc/Undef.pbc
	$(LINK) --output=$@  $(KRT0) t/Pmc/Undef.pbc > $@

t/UnitTest/AllTests.t.pbc: $(KRT0) t/UnitTest/AllTests.pbc
	$(LINK) --output=$@  $(KRT0) t/UnitTest/AllTests.pbc > $@

t/UnitTest/Loader.t.pbc: $(KRT0) t/UnitTest/Loader.pbc
	$(LINK) --output=$@  $(KRT0) t/UnitTest/Loader.pbc > $@

t/UnitTest/Suite.t.pbc: $(KRT0) t/UnitTest/Suite.pbc
	$(LINK) --output=$@  $(KRT0) t/UnitTest/Suite.pbc > $@

t/UnitTest/Testcase.t.pbc: $(KRT0) t/UnitTest/Testcase.pbc
	$(LINK) --output=$@  $(KRT0) t/UnitTest/Testcase.pbc > $@

# Need fixin
t/Classes/test-Attributes.pbc: $(KRT0) t/Classes/Attributes.pbc
	$(LINK) --output=$@ $(KRT0) t/Classes/Attributes.pbc
	
t/Pmc/test-array.pbc: $(KRT0) t/Pmc/Array.pbc
	$(LINK) --output=$@  $(KRT0) t/Pmc/Array.pbc > $@

t/Pmc/test-rpa.pbc: $(KRT0) t/Pmc/ResizablePMCArray.pbc
	$(LINK) --output=$@ $(KRT0) t/Pmc/ResizablePMCArray.pbc

t/Pmc/test-rsa.pbc: $(KRT0) t/Pmc/ResizableStringArray.pbc	
	$(LINK) --output=$@ $(KRT0) t/Pmc/ResizableStringArray.pbc

t/Pmc/test-undef.pbc: $(KRT0)  t/Pmc/Undef.pbc
	$(LINK) --output=$@ $(KRT0) t/Pmc/Undef.pbc

t/Sanity/test-P6object.pbc: $(KRT0) t/Sanity/P6object.pbc
	$(LINK) --output=$@ $(KRT0) t/Sanity/P6object.pbc

testclean:
	$(RM_F) $(TEST_CLEANUPS)

uninstall:
	$(RM_F) $(LIB_DIR)/library/kakapo_base.pbc
	$(RM_F) $(LIB_DIR)/library/kakapo_test.pbc
	$(RM_RF) $(DOC_DIR)/kakapo
